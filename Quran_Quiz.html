<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مسابقة النور القرآني - سورة الإخلاص والمولد المهدوي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;800;900&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mahdi: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a', // أخضر مهدوي
                            800: '#166534',
                            900: '#14532d',
                        },
                        gold: {
                            400: '#fbbf24',
                            500: '#f59e0b', // ذهبي قرآني
                            600: '#d97706',
                        }
                    },
                    fontFamily: {
                        quran: ['Amiri', 'serif'],
                        modern: ['Cairo', 'sans-serif'],
                        ui: ['Tajawal', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 12s linear infinite',
                        'bounce-in': 'bounceIn 0.8s cubic-bezier(0.215, 0.610, 0.355, 1.000) both',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        bounceIn: {
                            '0%': { opacity: '0', transform: 'scale3d(0.3, 0.3, 0.3)' },
                            '20%': { transform: 'scale3d(1.1, 1.1, 1.1)' },
                            '40%': { transform: 'scale3d(0.9, 0.9, 0.9)' },
                            '60%': { opacity: '1', transform: 'scale3d(1.03, 1.03, 1.03)' },
                            '80%': { transform: 'scale3d(0.97, 0.97, 0.97)' },
                            '100%': { opacity: '1', transform: 'scale3d(1, 1, 1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* أنماط إضافية خاصة */
        body {
            background-color: #f0fdfa;
            background-image: radial-gradient(#115e59 1px, transparent 1px), radial-gradient(#115e59 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            background-attachment: fixed;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .card-shiny {
            position: relative;
            overflow: hidden;
        }
        .card-shiny::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
            transition: 0.5s;
        }
        .card-shiny:hover::before {
            left: 150%;
            transition: 0.7s;
        }

        /* تأثير ثلاثي الأبعاد للأزرار */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 6px solid #b45309; /* Darker shade */
        }
        .btn-3d:active {
            transform: translateY(4px);
            border-bottom: 2px solid #b45309;
        }

        /* تحسين التمرير */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #ccfbf1; }
        ::-webkit-scrollbar-thumb { background: #0d9488; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #0f766e; }

        .pattern-overlay {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2310b981' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 1. قاعدة البيانات (الأسئلة المستوحاة من الصور)
        // ==========================================
        const QUESTIONS_DATA = [
            // المجموعة الأولى: سورة الإخلاص (مستوحى من الصور)
            { id: 1, cat: 'quran', q: "ما هو اسم السورة التي تعدل ثلث القرآن؟", a: ["سورة الناس", "سورة الإخلاص", "سورة الفلق", "سورة المسد"], correct: 1 },
            { id: 2, cat: 'quran', q: "أكمل الآية: (قُلْ هُوَ اللَّهُ ...)", a: ["رَحِيمٌ", "أَحَدٌ", "قَدِيرٌ", "كَرِيمٌ"], correct: 1 },
            { id: 3, cat: 'meaning', q: "ما معنى كلمة (الصَّمَدُ)؟", a: ["الذي يحتاج للناس", "الذي يقصده الجميع في الحوائج", "القوي جداً", "الكبير في العمر"], correct: 1 },
            { id: 4, cat: 'story', q: "من هو الصحابي الذي كان يردد (أَحَدٌ.. أَحَدٌ) تحت التعذيب؟", a: ["عمار بن ياسر", "بلال الحبشي", "سلمان المحمدي", "أبو ذر الغفاري"], correct: 1 },
            { id: 5, cat: 'quran', q: "أكمل الآية: (وَلَمْ يَكُن لَّهُ ... أَحَدٌ)", a: ["وَلَدًا", "شَرِيكًا", "كُفُوًا", "وَالِدًا"], correct: 2 },
            { id: 6, cat: 'meaning', q: "نزلت سورة الإخلاص رداً على الكفار عندما سألوا عن:", a: ["نسب الله (صفة الله)", "موعد القيامة", "قصص الأنبياء", "كيفية الصلاة"], correct: 0 },
            { id: 7, cat: 'story', q: "كان بلال يوضع على صدره صخرة عظيمة في رمضاء...", a: ["المدينة", "مكة", "الطائف", "الشام"], correct: 1 },
            { id: 8, cat: 'mahdi', q: "قال الإمام الصادق (ع): إذا قام القائم لا يبقى أرض إلا نودي فيها بـ...", a: ["الأذان والشهادتين", "القصائد", "الأخبار", "الأسماء"], correct: 0 },
            { id: 9, cat: 'quran', q: "ما معنى (لَمْ يَلِدْ)؟", a: ["ليس له ابن", "ليس له أب", "ليس له أخ", "ليس له بيت"], correct: 0 },
            { id: 10, cat: 'story', q: "أصبح بلال الحبشي بعد حرية الإسلام:", a: ["تاجر المدينة", "مؤذن الرسول (ص)", "قائد الجيش", "كاتب الوحي"], correct: 1 },
            
            // المجموعة الثانية: أسئلة مهدوية وثقافة عامة
            { id: 11, cat: 'mahdi', q: "من هو إمام زماننا الذي ننتظر ظهوره؟", a: ["الإمام المهدي (عج)", "الإمام الحسين (ع)", "الإمام علي (ع)", "النبي عيسى (ع)"], correct: 0 },
            { id: 12, cat: 'tf', q: "صح أم خطأ: المشركون كانوا يعبدون الأصنام المصنوعة من الحجارة.", a: ["صح", "خطأ"], correct: 0 },
            { id: 13, cat: 'quran', q: "عدد آيات سورة الإخلاص هو:", a: ["3 آيات", "4 آيات", "5 آيات", "6 آيات"], correct: 1 },
            { id: 14, cat: 'mahdi', q: "عندما يظهر الإمام المهدي سيملأ الأرض...", a: ["ذهباً وفضة", "قسطاً وعدلاً", "قصوراً وبيوت", "أشجاراً وأنهار"], correct: 1 },
            { id: 15, cat: 'quran', q: "قراءة سورة الإخلاص 3 مرات تعادل أجر قراءة:", a: ["نصف القرآن", "ربع القرآن", "القرآن كاملاً", "سورة البقرة"], correct: 2 },
            { id: 16, cat: 'meaning', q: "معنى (لَمْ يُولَدْ) أي:", a: ["ليس له أولاد", "ليس له أب ولا أم", "لم يخلقه أحد", "لا ينام"], correct: 1 },
            { id: 17, cat: 'story', q: "من الذي كان يعذب بلالاً الحبشي؟", a: ["أبو جهل", "أمية بن خلف", "أبو لهب", "فرعون"], correct: 1 },
            { id: 18, cat: 'tf', q: "صح أم خطأ: الله سبحانه وتعالى يشبه الإنسان.", a: ["صح", "خطأ سبحانه (ليس كمثله شيء)"], correct: 1 },
            { id: 19, cat: 'mahdi', q: "ماذا نقول عندما نسمع اسم (القائم)؟", a: ["نصفق", "نقوم احتراماً ونضع اليد على الرأس", "نجلس", "نغمض أعيننا"], correct: 1 },
            { id: 20, cat: 'meaning', q: "كلمة (أَحَد) في السورة تعني:", a: ["واحد لا شريك له", "رقم واحد", "يوم الأحد", "أحد الناس"], correct: 0 },
            { id: 21, cat: 'story', q: "هل استسلم بلال للكفار وعبد الأصنام؟", a: ["نعم استسلم", "لا، صبر وثبت على الإيمان", "هرب منهم", "لم يقل شيئاً"], correct: 1 },
            { id: 22, cat: 'quran', q: "في أي ركعة نقرأ سورة الإخلاص غالباً في الصلاة؟", a: ["بعد الفاتحة في الأولى والثانية", "في الركوع", "في السجود", "في التشهد"], correct: 0 },
            { id: 23, cat: 'tf', q: "صح أم خطأ: الإمام المهدي يراقب أعمالنا ويفرح بطاعتنا.", a: ["صح", "خطأ"], correct: 0 },
            { id: 24, cat: 'mahdi', q: "لقب (المنتظَر) يعني أننا:", a: ["ننتظر الحافلة", "ننتظر ظهوره المبارك", "ننتظر المدرسة", "ننتظر الطعام"], correct: 1 },
            { id: 25, cat: 'bonus', q: "سؤال الجائزة: ما هي أعظم كلمة رددها بلال وهو تحت الصخرة؟", a: ["يا محمد", "أحدٌ أحد", "ساعدوني", "النجدة"], correct: 1 },
        ];

        // ==========================================
        // 2. نظام الصوتيات (Web Audio API)
        // ==========================================
        const AudioEngine = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playWin: function() {
                // لحن الفوز (تتابعي)
                const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50];
                notes.forEach((n, i) => setTimeout(() => this.playTone(n, 'triangle', 0.5, 0.2), i * 150));
            },
            playCorrect: function() {
                this.playTone(880, 'sine', 0.1, 0.2);
                setTimeout(() => this.playTone(1760, 'sine', 0.3, 0.2), 100);
            },
            playWrong: function() {
                this.playTone(150, 'sawtooth', 0.3, 0.3);
                setTimeout(() => this.playTone(100, 'sawtooth', 0.4, 0.3), 150);
            },
            playClick: function() {
                this.playTone(400, 'sine', 0.1, 0.1);
            },
            playSpin: function() {
                this.playTone(600, 'square', 0.05, 0.05);
            }
        };

        // ==========================================
        // 3. المكونات الفرعية (Components)
        // ==========================================

        // مكون: واجهة الترحيب
        const WelcomeScreen = ({ onStart }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-4 relative z-10 text-center">
                <div className="absolute inset-0 bg-gradient-to-br from-mahdi-100 to-white opacity-90 z-0"></div>
                <div className="z-10 bg-white/80 backdrop-blur-md p-8 md:p-12 rounded-[3rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] border-4 border-gold-400 max-w-2xl w-full animate-bounce-in">
                    
                    <div className="mb-6 flex justify-center">
                        <div className="w-24 h-24 bg-mahdi-100 rounded-full flex items-center justify-center border-4 border-mahdi-600 animate-pulse-slow">
                            <i data-lucide="book-open" className="w-12 h-12 text-mahdi-600"></i>
                        </div>
                    </div>

                    <h1 className="text-4xl md:text-6xl font-black text-mahdi-800 font-modern mb-2">مسابقة النور</h1>
                    <h2 className="text-2xl md:text-3xl font-bold text-gold-600 font-quran mb-8">سورة الإخلاص والمولد المهدوي</h2>

                    <div className="space-y-4">
                        <button onClick={onStart} className="w-full py-4 bg-gradient-to-r from-mahdi-600 to-mahdi-500 text-white text-2xl font-bold rounded-2xl shadow-lg hover:shadow-2xl hover:scale-105 transform transition-all duration-300 flex items-center justify-center gap-3 btn-3d">
                            <i data-lucide="play" fill="currentColor"></i>
                            ابدأ المسابقة
                        </button>
                    </div>

                    <div className="mt-8 pt-4 border-t border-gray-200">
                        <p className="text-mahdi-800 font-bold font-ui">إعداد: أ. حسن سديف</p>
                    </div>
                </div>
                
                {/* زينة الخلفية */}
                <div className="absolute top-10 left-10 opacity-20 animate-float">
                    <i data-lucide="moon" size={80} className="text-gold-500"></i>
                </div>
                <div className="absolute bottom-10 right-10 opacity-20 animate-float" style={{animationDelay: '1s'}}>
                    <i data-lucide="sun" size={80} className="text-gold-500"></i>
                </div>
            </div>
        );

        // مكون: عجلة الأسماء
        const WheelModal = ({ isOpen, onClose, students, setStudents }) => {
            const [rotation, setRotation] = useState(0);
            const [winner, setWinner] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [isEdit, setIsEdit] = useState(false);
            const [namesText, setNamesText] = useState(students.join('\n'));

            if (!isOpen) return null;

            const spinWheel = () => {
                if (isSpinning || students.length < 2) return;
                setIsSpinning(true);
                setWinner(null);
                
                const newRotation = rotation + 1440 + Math.random() * 360;
                setRotation(newRotation);

                // صوت الدوران
                let count = 0;
                const interval = setInterval(() => {
                    AudioEngine.playSpin();
                    count++;
                    if(count > 20) clearInterval(interval);
                }, 100);

                setTimeout(() => {
                    setIsSpinning(false);
                    // حساب الفائز
                    const actualDeg = newRotation % 360;
                    const sliceDeg = 360 / students.length;
                    const winningIndex = Math.floor(((360 - actualDeg + 90) % 360) / sliceDeg); 
                    // adjustment for arrow position (top)
                    
                    const luckyStudent = students[Math.floor(Math.random() * students.length)]; // تبسيط منطق الفوز للعرض
                    setWinner(luckyStudent);
                    AudioEngine.playWin();
                    confetti({ particleCount: 200, spread: 100, zIndex: 60 });
                }, 3000);
            };

            const saveNames = () => {
                const arr = namesText.split('\n').filter(n => n.trim() !== "");
                setStudents(arr);
                localStorage.setItem('quran_contest_names', JSON.stringify(arr));
                setIsEdit(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-bounce-in">
                    <div className="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="bg-mahdi-600 p-4 text-white flex justify-between items-center">
                            <h3 className="text-xl font-bold font-modern flex gap-2"><i data-lucide="users"></i> قرعة الأبطال</h3>
                            <button onClick={onClose}><i data-lucide="x"></i></button>
                        </div>
                        
                        <div className="p-6 bg-slate-50 flex flex-col items-center flex-1 overflow-y-auto">
                            {isEdit ? (
                                <div className="w-full">
                                    <textarea className="w-full h-48 border-2 border-mahdi-300 rounded-xl p-2 font-bold text-center" value={namesText} onChange={e => setNamesText(e.target.value)}></textarea>
                                    <button onClick={saveNames} className="w-full mt-2 bg-mahdi-600 text-white py-2 rounded-xl font-bold">حفظ الأسماء</button>
                                </div>
                            ) : (
                                <>
                                    {winner ? (
                                        <div className="text-center py-10">
                                            <p className="text-gray-500 font-bold">الطالب المختار هو:</p>
                                            <h1 className="text-5xl font-black text-gold-600 font-modern my-4 drop-shadow-md animate-bounce">{winner}</h1>
                                            <button onClick={() => setWinner(null)} className="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg font-bold">إغلاق</button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="relative w-64 h-64 my-6">
                                                <div className="absolute -top-4 left-1/2 -translate-x-1/2 z-20 text-red-600 drop-shadow-lg"><i data-lucide="arrow-down" size={40} fill="currentColor"></i></div>
                                                <div className="w-full h-full rounded-full border-8 border-gold-400 shadow-xl overflow-hidden relative transition-transform duration-[3000ms] cubic-bezier(0.25, 0.1, 0.25, 1)"
                                                     style={{ transform: `rotate(${rotation}deg)`, background: `conic-gradient(from 0deg, #10b981, #3b82f6, #f59e0b, #ef4444, #8b5cf6, #10b981)` }}>
                                                    {/* عجلة بصرية بسيطة */}
                                                    <div className="absolute inset-0 flex items-center justify-center text-white font-bold text-xs">
                                                        <div className="bg-white w-8 h-8 rounded-full shadow-inner"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button onClick={spinWheel} disabled={isSpinning} className="w-full py-3 bg-gold-500 text-white font-black text-xl rounded-xl shadow-lg btn-3d">
                                                {isSpinning ? 'جاري التدوير...' : 'اختر بطلاً!'}
                                            </button>
                                        </>
                                    )}
                                    <button onClick={() => setIsEdit(true)} className="mt-4 text-gray-400 text-sm font-bold flex gap-1 items-center hover:text-mahdi-600"><i data-lucide="edit-3" size={14}></i> تعديل القائمة ({students.length})</button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // مكون: سؤال المسابقة (مثل من سيربح المليون)
        const QuestionModal = ({ question, onClose, onSolve }) => {
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [status, setStatus] = useState(null); // 'correct', 'wrong'

            useEffect(() => AudioEngine.playClick(), []);

            const handleAnswer = (idx) => {
                if (status) return; // منع النقر المتكرر
                setSelectedIdx(idx);

                if (idx === question.correct) {
                    setStatus('correct');
                    AudioEngine.playCorrect();
                    confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                    setTimeout(() => {
                        onSolve(true);
                    }, 2500);
                } else {
                    setStatus('wrong');
                    AudioEngine.playWrong();
                    setTimeout(() => {
                        setStatus(null); // السماح بالمحاولة مرة أخرى أو إغلاق
                        setSelectedIdx(null); // إعادة تعيين
                    }, 1500);
                }
            };

            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-mahdi-900/90 backdrop-blur-md p-4 animate-bounce-in">
                    <div className="w-full max-w-4xl bg-white rounded-3xl overflow-hidden shadow-2xl border-4 border-gold-500 flex flex-col">
                        
                        {/* رأس السؤال */}
                        <div className="bg-mahdi-800 p-8 text-center relative overflow-hidden">
                            <div className="absolute inset-0 pattern-overlay opacity-20"></div>
                            <div className="relative z-10">
                                <span className="inline-block bg-gold-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-3 shadow-md font-ui">
                                    {question.cat === 'quran' ? 'قرآن كريم' : question.cat === 'story' ? 'قصة وعبرة' : 'عقيدة مهدوية'}
                                </span>
                                <h2 className="text-2xl md:text-4xl font-black text-white font-quran leading-relaxed drop-shadow-lg">
                                    {question.q}
                                </h2>
                            </div>
                        </div>

                        {/* الخيارات */}
                        <div className="p-6 bg-slate-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                            {question.a.map((opt, i) => {
                                let btnClass = "relative p-4 md:p-6 rounded-2xl border-2 text-right transition-all duration-200 group hover:scale-[1.02] active:scale-95 shadow-sm flex items-center gap-4 text-lg md:text-xl font-bold font-ui cursor-pointer ";
                                
                                if (selectedIdx === i) {
                                    if (status === 'correct') btnClass += "bg-green-500 border-green-600 text-white shadow-[0_0_20px_rgba(34,197,94,0.6)] ring-4 ring-green-200";
                                    else if (status === 'wrong') btnClass += "bg-red-500 border-red-600 text-white animate-shake";
                                    else btnClass += "bg-blue-100 border-blue-400";
                                } else {
                                    btnClass += "bg-white border-gray-200 text-gray-700 hover:border-gold-400 hover:bg-yellow-50";
                                }

                                return (
                                    <button key={i} onClick={() => handleAnswer(i)} disabled={!!status && status !== 'wrong'} className={btnClass}>
                                        <span className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-lg shadow-inner ${selectedIdx === i && status === 'correct' ? 'bg-white text-green-600' : 'bg-slate-200 text-slate-500'}`}>
                                            {String.fromCharCode(65+i)}
                                        </span>
                                        {opt}
                                        {selectedIdx === i && status === 'correct' && <i data-lucide="check-circle" className="absolute left-4 animate-bounce"></i>}
                                        {selectedIdx === i && status === 'wrong' && <i data-lucide="x-circle" className="absolute left-4"></i>}
                                    </button>
                                );
                            })}
                        </div>

                        {/* شريط الأدوات */}
                        <div className="bg-gray-50 p-4 border-t border-gray-200 flex justify-between items-center">
                             <button onClick={() => onClose()} className="text-gray-400 hover:text-red-500 font-bold text-sm">انسحاب مؤقت</button>
                             <div className="flex gap-2">
                                 {status === 'wrong' && <span className="text-red-600 font-bold animate-pulse">حاول مرة أخرى!</span>}
                                 {status === 'correct' && <span className="text-green-600 font-bold">إجابة صحيحة! أحسنت</span>}
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 4. التطبيق الرئيسي (Main App)
        // ==========================================
        const App = () => {
            const [screen, setScreen] = useState('welcome');
            const [cards, setCards] = useState([]);
            const [currentQ, setCurrentQ] = useState(null);
            const [score, setScore] = useState(0);
            const [showWheel, setShowWheel] = useState(false);
            const [students, setStudents] = useState(["محمد", "علي", "حسن", "حسين", "عباس", "رضا", "أحمد", "جاسم"]);

            useEffect(() => {
                // تحميل الأيقونات
                lucide.createIcons();
                
                // تحميل الأسماء من الذاكرة
                const savedNames = localStorage.getItem('quran_contest_names');
                if (savedNames) setStudents(JSON.parse(savedNames));

                // تهيئة البطاقات
                const initCards = QUESTIONS_DATA.map((q, i) => ({
                    ...q,
                    number: i + 1,
                    isSolved: false
                }));
                setCards(initCards);
            }, []);

            useEffect(() => {
                setTimeout(() => lucide.createIcons(), 100);
            }, [screen, currentQ, showWheel]);

            const startGame = () => {
                AudioEngine.playClick();
                setScreen('game');
            };

            const openQuestion = (card) => {
                if (card.isSolved) return;
                setCurrentQ(card);
            };

            const handleQuestionSolved = (success) => {
                if (success) {
                    setScore(s => s + 10);
                    setCards(prev => prev.map(c => c.id === currentQ.id ? { ...c, isSolved: true } : c));
                }
                setCurrentQ(null);
            };

            // الشاشة الرئيسية للعبة
            const GameBoard = () => (
                <div className="min-h-screen pb-20">
                    {/* الهيدر */}
                    <header className="bg-white/90 backdrop-blur shadow-md sticky top-0 z-30 px-4 py-3 flex justify-between items-center border-b border-mahdi-100">
                        <div className="flex items-center gap-4">
                            <div className="bg-mahdi-100 p-2 rounded-xl">
                                <i data-lucide="trophy" className="text-mahdi-600"></i>
                            </div>
                            <div>
                                <div className="text-xs text-gray-400 font-bold">النقاط</div>
                                <div className="text-2xl font-black text-mahdi-800 font-modern">{score}</div>
                            </div>
                        </div>
                        <h1 className="hidden md:block text-xl font-bold text-gray-700 font-quran">مسابقة القرآن الكريم المهدوية</h1>
                        <button onClick={() => setScreen('welcome')} className="p-2 text-gray-400 hover:text-red-500 transition"><i data-lucide="log-out"></i></button>
                    </header>

                    {/* شبكة الأسئلة */}
                    <main className="container mx-auto p-4 md:p-8">
                        <div className="grid grid-cols-3 md:grid-cols-5 gap-3 md:gap-6">
                            {cards.map((card) => (
                                <button
                                    key={card.id}
                                    onClick={() => openQuestion(card)}
                                    disabled={card.isSolved}
                                    className={`aspect-[4/5] rounded-2xl relative overflow-hidden shadow-lg transition-all duration-300 group
                                        ${card.isSolved 
                                            ? 'bg-gray-200 cursor-default opacity-60 scale-95 ring-2 ring-gray-300' 
                                            : 'bg-gradient-to-br from-mahdi-600 to-teal-800 hover:scale-105 hover:shadow-2xl hover:shadow-mahdi-500/30 card-shiny border-b-4 border-teal-900'}
                                    `}
                                >
                                    <div className="absolute inset-0 pattern-overlay opacity-10"></div>
                                    <div className="relative z-10 w-full h-full flex flex-col items-center justify-center">
                                        {card.isSolved ? (
                                            <i data-lucide="check" size={48} className="text-gray-400" />
                                        ) : (
                                            <>
                                                <div className="text-5xl md:text-6xl font-black text-white font-modern drop-shadow-md group-hover:scale-110 transition-transform">{card.number}</div>
                                                <div className="mt-2 text-mahdi-200 text-xs font-bold font-ui bg-black/20 px-2 py-1 rounded-full">
                                                    {card.cat === 'quran' ? 'قرآن' : card.cat === 'mahdi' ? 'مهدوي' : 'سيرة'}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    {/* Icon corner */}
                                    {!card.isSolved && (
                                        <div className="absolute top-2 left-2 text-white/30">
                                            <i data-lucide={card.cat === 'mahdi' ? 'star' : 'book'} size={16}></i>
                                        </div>
                                    )}
                                </button>
                            ))}
                        </div>
                    </main>

                    {/* زر القرعة العائم */}
                    <button 
                        onClick={() => setShowWheel(true)}
                        className="fixed bottom-6 left-6 z-40 bg-gradient-to-r from-gold-500 to-orange-600 text-white p-4 md:px-8 md:py-4 rounded-full shadow-[0_4px_20px_rgba(245,158,11,0.5)] hover:scale-105 hover:-translate-y-1 transition-all duration-300 flex items-center gap-3 border-2 border-white ring-4 ring-gold-200"
                    >
                        <i data-lucide="aperture" className="animate-spin-slow"></i>
                        <span className="hidden md:inline font-bold text-lg font-ui">قرعة الطلاب</span>
                    </button>
                </div>
            );

            return (
                <div className="font-ui text-gray-800 antialiased selection:bg-mahdi-200 selection:text-mahdi-900">
                    {screen === 'welcome' && <WelcomeScreen onStart={startGame} />}
                    {screen === 'game' && <GameBoard />}
                    
                    {currentQ && (
                        <QuestionModal 
                            question={currentQ} 
                            onClose={() => setCurrentQ(null)} 
                            onSolve={handleQuestionSolved} 
                        />
                    )}

                    <WheelModal 
                        isOpen={showWheel} 
                        onClose={() => setShowWheel(false)}
                        students={students}
                        setStudents={setStudents}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
